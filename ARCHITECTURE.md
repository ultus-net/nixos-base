# Architecture

This document explains the repository structure and design decisions.

## Repository Layout

```
nixos-base/
├── flake.nix              # Main flake defining all configurations
├── modules/               # Reusable NixOS modules
├── profiles/              # Desktop environment profiles
├── machines/              # Machine-specific configurations
├── home/                  # Home Manager configurations
├── scripts/               # Helper scripts
└── .github/              # CI/CD workflows
```

## Design Philosophy

### Composition Over Inheritance

This flake uses **composition** to build configurations:

- **Modules** (`modules/`) are small, focused pieces (audio, gaming, development)
- **Profiles** (`profiles/`) compose modules into complete desktop environments
- **Machines** (`machines/`) compose profiles with hardware-specific config

### Desktop Agnostic Core

The core configuration (`machines/configuration.nix`) is desktop-agnostic:
- Boot configuration
- Locale and timezone
- SSH and networking
- User management
- System maintenance

Desktop-specific configuration lives in `profiles/` and their imported modules.

## Flake Structure

### Inputs
- **nixpkgs** - Pinned to a specific commit for reproducibility
- **home-manager** - User environment management
- **nixos-cosmic** - COSMIC desktop environment
- **flake-utils** - Flake utilities for multi-system support
- **devshell** - Development shell configuration

### Outputs

#### Per-System Outputs
Available on all supported systems (x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin):

- **devShells.default** - Development environment with tools
- **packages.default** - QoL package bundle
- **packages.cosmicImage** - Docker image with dev tools
- **packages.kdeImage** - Docker image for KDE development
- **homeManagerModules.default** - Home Manager module for QoL

#### System-Wide Outputs
Available at the top level:

- **nixosConfigurations** - All 10 system configurations (9 desktops + 1 headless)
- **homeConfigurations** - Standalone Home Manager configurations
- **templates** - Project templates for new configurations

## Module System

### Module Categories

1. **Desktop Environments** (`modules/*-desktop.nix`)
   - Self-contained desktop environment configuration
   - Examples: `gnome.nix`, `kde.nix`, `cosmic.nix`

2. **Feature Modules** (`modules/*.nix`)
   - Optional functionality (gaming, development, multimedia)
   - Enabled via `<module>.enable = true;`

3. **Core Modules** (`modules/common-*.nix`)
   - Essential functionality (packages, users, security)
   - Usually imported by profiles

### Module Design Pattern

Modules follow this pattern:

```nix
{ config, lib, pkgs, ... }:
{
  options.<namespace>.<feature> = {
    enable = lib.mkEnableOption "description";
    # Additional options...
  };

  config = lib.mkIf config.<namespace>.<feature>.enable {
    # Configuration here...
  };
}
```

### Namespace Conventions

- `commonPackages.*` - Common package configuration
- `machines.*` - Machine-level configuration (users, zram)
- `multimedia.*` - Multimedia feature configuration
- `gaming.*` - Gaming feature configuration
- `development.*` - Development tools configuration
- (etc.)

## Profile Structure

Profiles compose modules into complete desktop environments:

```nix
{ config, pkgs, lib, inputs, ... }:
{
  imports = [
    ../machines/configuration.nix  # Base machine config
    ../modules/common-packages.nix # CLI tools
    ../modules/gnome.nix           # Desktop environment
    ../modules/audio.nix           # Audio support
    ../modules/fonts.nix           # Font configuration
    # ... other modules
  ];

  # Profile-specific configuration
  commonPackages.enable = true;
  # ...
}
```

## Machine Configuration

Machine configurations are deployment-specific:

1. Import base configuration (`machines/configuration.nix`)
2. Import hardware configuration (generated by installer)
3. Import chosen profile
4. Set machine-specific options (hostname, users, etc.)

Example:
```nix
{ config, pkgs, lib, inputs, ... }:
{
  imports = [
    ./configuration.nix
    ./hardware-configuration.nix
    ../profiles/gnome.nix
  ];

  networking.hostName = "my-laptop";

  machines.users.alice = {
    enable = true;
    isAdmin = true;
  };
}
```

## Configuration Flow

```
flake.nix
  └─> nixosConfigurations.<name>
       └─> machines/<name>.nix or profiles/<name>.nix
            ├─> machines/configuration.nix (base)
            ├─> hardware-configuration.nix (hardware)
            └─> profiles/<desktop>.nix (desktop)
                 ├─> modules/common-packages.nix
                 ├─> modules/<desktop>.nix
                 ├─> modules/audio.nix
                 ├─> modules/fonts.nix
                 └─> modules/home-manager.nix
```

## Home Manager Integration

Home Manager is integrated two ways:

1. **NixOS Module** - Included in system configurations
2. **Standalone** - For non-NixOS systems

The `homeManagerModules.default` provides a reusable module with:
- Shell configuration (bash, starship)
- Git configuration
- Neovim setup
- VSCode configuration
- Development tools

## CI/CD Pipeline

The GitHub Actions workflow validates:

1. **Basic Validation** - Syntax checks, structure validation
2. **Flake Structure** - Metadata and expected outputs
3. **Build Configurations** - All 10 configurations evaluate correctly
4. **Module Validation** - All modules have valid syntax
5. **Security Checks** - Scan for hardcoded secrets
6. **Home Manager** - Standalone configurations validate
7. **VM Boot Tests** - Critical configurations actually boot

See `.github/CI-CD-GUIDE.md` for complete pipeline documentation.

## Nixpkgs Pin

This flake pins nixpkgs to a specific commit for reproducibility:

```nix
nixpkgs.url = "github:NixOS/nixpkgs/16c7794d0a28b5a37904d55bcca36003b9109aaa";
```

To update:
```bash
nix flake lock --update-input nixpkgs
```

## User Management

Users are managed via the `machines.users` option defined in `modules/common-users.nix`:

```nix
machines.users.alice = {
  enable = true;
  isAdmin = true;  # Add to wheel group
  shell = pkgs.bash;
};
```

This creates:
- User account with home directory
- Appropriate group memberships
- Shell configuration
- Home Manager integration (if enabled)

## ZRAM Configuration

ZRAM swap is configured via `modules/zram.nix`:

```nix
machines.zram.enableAutoSize = true;  # Auto-size based on RAM
machines.zram.maxSize = 4294967296;   # 4GiB max
machines.zram.compAlgorithm = "lz4";  # Compression algorithm
```

Auto-sizing uses: `min(total_ram / 2, maxSize)`

## System Maintenance

Automatic garbage collection is configured in `machines/configuration.nix`:

- Runs daily via systemd timer
- Keeps last 3 generations
- Removes store paths older than 14 days

Override per-machine if needed:
```nix
nix.gc = {
  automatic = true;
  dates = "weekly";
  options = "--delete-older-than 30d";
};
```

## Security Configuration

Security defaults from `modules/security.nix`:

- Firewall enabled
- SSH key-based auth only
- No root login
- Fingerprint auth (if hardware available)
- mDNS/Avahi for local discovery

Additional hardening available in `machines/configuration.nix`.

## Development Environment

The flake provides a dev shell with tools:

```bash
nix develop
```

Includes:
- Nix formatters and linters
- Development tools (git, gh, direnv)
- Language toolchains (Python, Node.js, Go, Rust)
- Container tools (podman)
- Build tools (cmake, pkg-config, just)

## Testing Strategy

1. **Local Testing** - `nix flake check`
2. **Build Testing** - Dry-run builds
3. **VM Testing** - Boot VMs to verify functionality
4. **CI Testing** - Automated testing on push/PR

See `USAGE.md` for testing commands.

## Migration from Legacy Structure

Previous versions used `hosts/` for configurations. This was refactored to:
- `profiles/` - Reusable desktop configurations
- `machines/` - Machine-specific deployments

Old files are in `hosts-deprecated/` for reference.

## Contributing

When adding new features:

1. Create focused modules in `modules/`
2. Document options and usage
3. Update relevant profiles
4. Add tests to CI pipeline
5. Update documentation

See `CONTRIBUTING.md` for detailed contribution guidelines.
