name: Comprehensive NixOS Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Quick validation checks
  validate-basics:
    name: Basic Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate profiles & machines import Home Manager
        run: bash ./scripts/validate-hosts-home-manager.sh

      - name: Ensure profiles and machines exist
        run: |
          test -n "$(ls -A profiles 2>/dev/null || true)"
          test -n "$(ls -A machines 2>/dev/null || true)"

      - name: Install Nix (for syntax checking)
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Check for syntax errors in Nix files
        run: |
          find . -name "*.nix" -type f -print0 | xargs -0 -I {} sh -c 'nix-instantiate --parse {} > /dev/null || exit 1'

  # Flake metadata and structure validation
  validate-flake-structure:
    name: Flake Structure Validation
    runs-on: ubuntu-latest
    needs: validate-basics
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: "nixpkgs=github:NixOS/nixpkgs/nixpkgs-unstable"
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      # Cachix disabled - not needed for this repository
      # - name: Setup Cachix (optional, speeds up builds)
      #   uses: cachix/cachix-action@v14
      #   with:
      #     name: nixos-cosmic
      #     authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      #   continue-on-error: true

      - name: Validate flake metadata
        run: |
          nix flake metadata
          nix flake show --json . > flake.json
          cat flake.json | jq '.nixosConfigurations | keys'

      - name: Check all expected configurations exist
        run: |
          # Check for base-server
          jq -e '.nixosConfigurations | has("base-server")' flake.json
          # Check for all desktop environments
          for desktop in cosmic gnome kde cinnamon xfce hyprland; do
            jq -e ".nixosConfigurations | has(\"${desktop}-workstation\")" flake.json
          done

      - name: Verify homeConfigurations exist
        run: |
          jq -e '.homeConfigurations' flake.json || echo "Note: homeConfigurations may show as 'unknown' in flake show but still exist"

      - name: Check homeManagerModules (informational only)
        run: |
          # homeManagerModules may show as "unknown" in older Nix versions but still work
          jq '.homeManagerModules' flake.json || echo "homeManagerModules present but not fully introspectable"
        continue-on-error: true

  # Build and evaluation checks
  build-configurations:
    name: Build Test - ${{ matrix.config }}
    runs-on: ubuntu-latest
    needs: validate-flake-structure
    strategy:
      fail-fast: false
      matrix:
        config:
          - base-server
          - cosmic-workstation
          - gnome-workstation
          - kde-workstation
          - cinnamon-workstation
          - xfce-workstation
          - hyprland-workstation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      # Cachix disabled - not needed for this repository
      # - name: Setup Cachix
      #   uses: cachix/cachix-action@v14
      #   with:
      #     name: nixos-cosmic
      #     authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      #   continue-on-error: true

      - name: Build system configuration (dry-run)
        run: |
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel --dry-run --show-trace

      - name: Check configuration evaluates without errors
        run: |
          nix eval .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel.drvPath

  # VM boot tests - actually test if systems boot
  # MANUAL ONLY: These tests only run when you add the 'test-vm-boot' label to a PR
  # They are resource-intensive and slow, but validate actual boot functionality
  vm-boot-tests:
    name: VM Boot Test - ${{ matrix.config }}
    runs-on: ubuntu-latest
    needs: build-configurations
    # Only run when PR has the 'test-vm-boot' label (manual trigger)
    if: contains(github.event.pull_request.labels.*.name, 'test-vm-boot')
    strategy:
      fail-fast: false
      matrix:
        config:
          - base-server
          - xfce-workstation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: Install Nix with KVM support
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Required for VM tests
            system-features = nixos-test benchmark big-parallel kvm

      # Cachix disabled - not needed for this repository
      # - name: Setup Cachix
      #   uses: cachix/cachix-action@v14
      #   with:
      #     name: nixos-cosmic
      #     authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      #   continue-on-error: true

      - name: Build VM for ${{ matrix.config }}
        run: |
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.vm -L

      - name: Test VM boots and reaches multi-user.target
        timeout-minutes: 15
        run: |
          # Start VM in background with serial output to file
          echo "Starting VM for ${{ matrix.config }}..."
          QEMU_KERNEL_PARAMS="console=ttyS0" ./result/bin/run-*-vm -nographic -m 2048 -serial file:vm-serial.log &
          VM_PID=$!
          
          # Wait for boot to complete (check for systemd reaching target)
          echo "Waiting for VM to boot (checking every 3 seconds, up to 12 minutes)..."
          BOOT_TIMEOUT=240  # 240 iterations * 3 seconds = 12 minutes
          
          for i in $(seq 1 $BOOT_TIMEOUT); do
            # Check if VM process is still running
            if ! kill -0 $VM_PID 2>/dev/null; then
              echo "✗ VM process died unexpectedly at iteration $i"
              echo "=== Last 100 lines of serial log ==="
              tail -100 vm-serial.log 2>/dev/null || cat vm-serial.log
              exit 1
            fi
            
            # Check for successful boot - try multiple patterns
            if grep -qE "(Reached target.*Multi-User System|Reached target.*Graphical Interface|systemd.*Reached target.*multi-user\.target)" vm-serial.log 2>/dev/null; then
              echo "✓ VM booted successfully! (iteration $i, ~$((i * 3)) seconds)"
              echo "=== Last 50 lines of successful boot ==="
              tail -50 vm-serial.log
              kill $VM_PID 2>/dev/null || true
              exit 0
            fi
            
            # Progress indicator every 20 iterations (every minute)
            if [ $((i % 20)) -eq 0 ]; then
              echo "  Still waiting... ($((i * 3)) seconds elapsed, ~$((BOOT_TIMEOUT * 3 - i * 3)) seconds remaining)"
              echo "  Log file size: $(wc -l < vm-serial.log 2>/dev/null || echo 0) lines"
            fi
            
            sleep 3
          done
          
          echo "✗ Timeout waiting for VM to boot after $((BOOT_TIMEOUT * 3)) seconds"
          echo "=== Full serial log ==="
          cat vm-serial.log
          kill $VM_PID 2>/dev/null || true
          exit 1

      - name: Upload VM serial log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vm-serial-log-${{ matrix.config }}
          path: vm-serial.log
          retention-days: 7

  # Module and package checks
  check-modules:
    name: Module Validation
    runs-on: ubuntu-latest
    needs: validate-basics
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Check all modules have valid Nix syntax
        run: |
          for module in modules/*.nix; do
            echo "Checking $module..."
            nix-instantiate --parse "$module" > /dev/null || exit 1
          done
          echo "✓ All modules have valid syntax"

      - name: Verify modules are used in configurations
        run: |
          echo "Checking that modules are referenced in profiles..."
          # This validates that our modules are actually being used
          for profile in profiles/*.nix; do
            echo "  Checking imports in $profile"
            grep -q "imports\s*=" "$profile" || echo "    Warning: $profile has no imports"
          done

      - name: Verify no broken symlinks
        run: |
          if find . -xtype l | grep -q .; then
            echo "Found broken symlinks:"
            find . -xtype l
            exit 1
          fi

  # Security and quality checks
  security-checks:
    name: Security & Quality
    runs-on: ubuntu-latest
    needs: validate-basics
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          if grep -r "password\s*=\s*\"[^$]" --include="*.nix" .; then
            echo "Found hardcoded passwords!"
            exit 1
          fi

      - name: Check for example emails/hostnames
        run: |
          if grep -r "@example\.(com|org|net)" --include="*.nix" . | grep -v "user@example.com" | grep -v "admin@example.org" | grep -q .; then
            echo "Found non-placeholder example emails!"
            exit 1
          fi

      - name: Validate git attributes
        run: |
          # Ensure .gitattributes exists and has basic settings
          test -f .gitattributes || echo "Warning: No .gitattributes file found"

  # Home Manager validation
  home-manager-check:
    name: Home Manager Validation
    runs-on: ubuntu-latest
    needs: validate-flake-structure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build Home Manager configuration
        run: |
          nix build .#homeConfigurations.\"hunter@x86_64-linux\".activationPackage --dry-run

      - name: Evaluate Home Manager configuration
        run: |
          nix eval .#homeConfigurations.\"hunter@x86_64-linux\".activationPackage.drvPath

  # Final summary job
  ci-success:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - validate-basics
      - validate-flake-structure
      - build-configurations
      - check-modules
      - security-checks
      - home-manager-check
    if: always()
    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.validate-basics.result }}" != "success" ] ||
             [ "${{ needs.validate-flake-structure.result }}" != "success" ] ||
             [ "${{ needs.build-configurations.result }}" != "success" ] ||
             [ "${{ needs.check-modules.result }}" != "success" ] ||
             [ "${{ needs.security-checks.result }}" != "success" ] ||
             [ "${{ needs.home-manager-check.result }}" != "success" ]; then
            echo "One or more required checks failed"
            exit 1
          fi
          echo "✓ All required checks passed!"

  # VM tests run separately and don't block the main pipeline
  vm-tests-summary:
    name: VM Tests Status
    runs-on: ubuntu-latest
    needs: vm-boot-tests
    # Only run this summary if VM tests actually ran
    if: always() && contains(github.event.pull_request.labels.*.name, 'test-vm-boot')
    steps:
      - name: Report VM test results
        run: |
          if [ "${{ needs.vm-boot-tests.result }}" == "success" ]; then
            echo "✓ All VM boot tests passed!"
          elif [ "${{ needs.vm-boot-tests.result }}" == "skipped" ]; then
            echo "ℹ️  VM boot tests were skipped (no 'test-vm-boot' label)"
          else
            echo "⚠ Some VM boot tests failed - check the logs"
            exit 1
          fi
