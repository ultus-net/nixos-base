name: Build and publish container

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-container:
    runs-on: ubuntu-latest
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v14
        with:
          nix_path: "nixpkgs=github:NixOS/nixpkgs/nixpkgs-unstable"

      - name: Enable experimental features for this run
        run: |
          mkdir -p $HOME/.config/nix
          echo 'extra-experimental-features = nix-command flakes' >> $HOME/.config/nix/nix.conf

      - name: Build container tars from flake (all desktops)
        id: build-all
        run: |
          set -euo pipefail
          mkdir -p $GITHUB_WORKSPACE/images
          IMAGES=(cosmicImage kdeImage gnomeImage)
          for IMG in "${IMAGES[@]}"; do
            echo "Building ${IMG}..."
            nix --extra-experimental-features 'nix-command flakes' build .#packages.x86_64-linux.${IMG}
            TAR_REL=$(find result -type f -name '*.tar*' -print -quit || true)
            if [ -z "$TAR_REL" ]; then
              echo "No tarball found for ${IMG} in build result:"; ls -la result || true; exit 1
            fi
            TAR_PATH=$(readlink -f "$TAR_REL")
            OUTNAME="$GITHUB_WORKSPACE/images/${IMG}.tar.gz"
            cp "$TAR_PATH" "$OUTNAME"
            echo "Wrote $OUTNAME"
            rm -rf result
          done

      - name: Upload image tars as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cosmic-image-tars
          path: images/*

      - name: Optionally push all images to GHCR
        if: env.GHCR_TOKEN != ''
        run: |
          set -euo pipefail
          GHCR_OWNER=${{ github.repository_owner }}
          for TAR in images/*; do
            BASENAME=$(basename "$TAR")
            IMG_KEY=${BASENAME%%.*} # cosmicImage, kdeImage, gnomeImage
            # normalize tag name: strip trailing 'Image' and lowercase
            IMG_NAME=$(echo "$IMG_KEY" | sed -E 's/Image$//' | tr '[:upper:]' '[:lower:]')
            echo "Loading $TAR"
            LOADED=$(docker load -i "$TAR" 2>&1)
            echo "$LOADED"
            IMAGE_NAME=$(echo "$LOADED" | sed -n 's/Loaded image: //p' | head -n1)
            if [ -z "$IMAGE_NAME" ]; then
              echo "Could not determine loaded image name; listing images for debugging"
              docker images --format '{{.Repository}}:{{.Tag}}'
              exit 1
            fi
            # tag per-desktop image name
            TARGET=ghcr.io/${GHCR_OWNER}/cosmic-dev-${IMG_NAME}:latest
            echo "Tagging $IMAGE_NAME -> $TARGET"
            docker tag "$IMAGE_NAME" "$TARGET"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            docker push "$TARGET"
          done
